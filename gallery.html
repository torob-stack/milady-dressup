<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Milady BonBon Gallery</title>
  <link rel="stylesheet" href="gallery.css" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  <div class="gallery-wrapper">
    <h1>üñºÔ∏è Milady BonBon Gallery</h1>
    <p>Here are the cutest doodles submitted by other Miladies!</p>

    <select id="sortSelect" onchange="sortGallery()">
      <option value="newest">Newest</option>
      <option value="oldest">Oldest</option>
      <option value="popular">Most Popular</option>
      <option value="unpopular">Least Popular</option>
    </select>

    <div id="gallery" class="gallery-grid"></div>
    <div class="gallery-error" style="display:none; color: red; margin-top: 1em;">
      ‚ö†Ô∏è Failed to load gallery. Try again later.
    </div>
    <a href="index.html" class="back-btn">‚Üê Back to Paint</a>
  </div>

  <script>
    let images = [];

    async function fetchImages() {
      try {
        const res = await axios.get('/api/gallery');
        images = res.data.images;
        sortGallery(); // initial render
      } catch (err) {
        console.error('Could not load images', err);
        document.querySelector('.gallery-error').style.display = 'block';
      }
    }

    function renderImages() {
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';
      const voted = JSON.parse(localStorage.getItem('votedImages') || '[]');

      images.forEach(img => {
        const container = document.createElement('div');
        container.className = 'gallery-item';

        const imageEl = document.createElement('img');
        imageEl.src = img.url;
        imageEl.alt = img.id;
        imageEl.className = 'gallery-img';

        const voteBtn = document.createElement('button');
        voteBtn.className = 'vote-btn';
        voteBtn.innerText = `üëç ${img.votes}`;
        voteBtn.disabled = voted.includes(img.id);
        voteBtn.onclick = () => voteImage(img.id, voteBtn);

        container.appendChild(imageEl);
        container.appendChild(voteBtn);
        gallery.appendChild(container);
      });
    }

    function sortGallery() {
      const sort = document.getElementById("sortSelect").value;
      images.sort((a, b) => {
        if (sort === "newest") return b.timestamp - a.timestamp;
        if (sort === "oldest") return a.timestamp - b.timestamp;
        if (sort === "popular") return (b.votes || 0) - (a.votes || 0);
        if (sort === "unpopular") return (a.votes || 0) - (b.votes || 0);
      });
      renderImages();
    }

    function voteImage(id, button) {
      const votedImages = JSON.parse(localStorage.getItem("votedImages") || "[]");
      if (votedImages.includes(id)) {
        alert("You‚Äôve already voted!");
        return;
      }

      fetch('/api/vote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const current = parseInt(button.innerText.split(" ")[1]);
          button.innerText = `üëç ${current + 1}`;
          votedImages.push(id);
          localStorage.setItem("votedImages", JSON.stringify(votedImages));
          button.disabled = true;
        }
      });
    }

    fetchImages();
  </script>
</body>
</html>
